#!/bin/bash

apt-get update -y
apt-get upgrade -y

# Install necessary packages
apt-get install -y nfs-common 

# Allow NFS and necessary port
ufw allow 22/tcp
ufw allow 80/tcp
ufw allow 443/tcp
ufw allow 2049/tcp
ufw allow 3306/tcp
ufw allow 10250/tcp 

# Enable and configure ufw
ufw --force enable 

# .......................Create mount directory..................

mkdir /mnt/APP_FILE
mkdir /mnt/MYSQL_BACKUP

# Create mount directory
REGION=ap-south-1

# .......................EFS DNS name............................

EFS_DNS_NAME_APP="Mention-EFS_ID_APP.efs.${REGION}.amazonaws.com"
EFS_DNS_NAME_MYSQL="Mention-EFS_ID_MYSQL-BACKUP.efs.${REGION}.amazonaws.com"

# .......................Mount EFS..............................

mount -t nfs ${EFS_DNS_NAME_APP}:/ /mnt/APP_FILE
mount -t nfs ${EFS_DNS_NAME_MYSQL}:/ /mnt/MYSQL_BACKUP

# ............add entry to /etc/fstab to ensure it's mounted on reboot.......................

echo "${EFS_DNS_NAME_APP}:/ /mnt/APP_FILE nfs defaults,_netdev 0 0" >> /etc/fstab
echo "${EFS_DNS_NAME_MYSQL}:/ /mnt/MYSQL_BACKUP nfs defaults,_netdev 0 0" >> /etc/fstab

# ......................Refresh Mount-path......................

mount -a
